<!DOCTYPE html>
<html lang="it" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kardex Viewer</title>
  <link rel="manifest" href="manifest.webmanifest?v=15" />
  <meta name="theme-color" content="#0e4ead" />
  <link rel="apple-touch-icon" href="assets/icon-512.png?v=15" />
  <link rel="icon" href="favicon.ico?v=15" type="image/x-icon">
  <style>
    :root {
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280;
      --primary:#0e4ead; --primary-weak:#e5efff; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(2,6,23,.08); --pill-bg:#eef2ff; --pill-text:#3730a3;
      --table-head:#f3f4f6; --row-alt:#fafafa; --row-hover:#f1f5ff;
    }
    @media (prefers-color-scheme: dark) {
      html[data-theme="auto"] {
        --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --primary:#60a5fa;
        --primary-weak:#0b1b38; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35);
        --pill-bg:#0b1b38; --pill-text:#bfdbfe; --table-head:#0b1b38; --row-alt:#0b1426; --row-hover:#142549;
      }
    }
    html[data-theme="dark"] {
      --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --primary:#60a5fa;
      --primary-weak:#0b1b38; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35);
      --pill-bg:#0b1b38; --pill-text:#bfdbfe; --table-head:#0b1b38; --row-alt:#0b1426; --row-hover:#142549;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text);margin:0}
    header{background:linear-gradient(135deg,var(--primary),#2563eb);color:#fff;padding:16px 18px;position:sticky;top:0;z-index:20;box-shadow:0 4px 18px rgba(0,0,0,.12)}
    .wrap{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:42px;height:42px;border-radius:12px;overflow:hidden;border:2px solid #ffffff55;background:#fff;display:flex;align-items:center;justify-content:center}
    .brand .logo img{width:100%;height:100%;object-fit:contain}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row>*{margin:4px 0}
    input[type="text"],input[type="number"],select,button{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text)}
    html[data-theme="dark"] input[type="text"],html[data-theme="dark"] input[type="number"],html[data-theme="dark"] select,html[data-theme="dark"] button{background:#0b1426;border-color:var(--border);color:var(--text)}
    input[readonly]{background:var(--table-head)}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer;transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    button.secondary{background:var(--primary-weak);color:var(--text)}
    .count{margin-left:auto;color:var(--muted);font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--pill-bg);color:var(--pill-text);border-radius:999px;padding:4px 10px;font-size:12px;font-weight:600;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;margin-top:12px;overflow:hidden}
    thead th{position:sticky;top:0;z-index:5;background:var(--table-head);color:var(--text);text-align:left;padding:12px;border-bottom:1px solid var(--border);user-select:none}
    th.sortable{cursor:pointer}
    th.sortable .sort{opacity:.8;font-size:12px;margin-left:6px}
    td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:nth-child(even){background:var(--row-alt)}
    tbody tr:hover{background:var(--row-hover)}
    @media (max-width:640px){
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{border:1px solid var(--border);border-radius:12px;padding:8px;margin-bottom:12px;background:var(--card)}
      td{display:grid;grid-template-columns:120px 1fr;gap:8px;border:none}
      td::before{content:attr(data-label);font-weight:600;color:var(--muted)}
    }
    .muted{color:var(--muted);font-size:14px}
    .hint{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toggle{background:#ffffff22;color:#fff;border:1px solid #ffffff44;padding:8px 10px;border-radius:12px;cursor:pointer;font-size:14px}
    footer{text-align:center;margin:16px 0;color:var(--muted);font-size:12px}
    details.filters{margin-top:10px}
    details.filters summary{cursor:pointer;padding:8px 10px;background:var(--table-head);border:1px solid var(--border);border-radius:12px}
    .filters .grid{margin-top:10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width:640px){.filters .grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}

    /* === Console stile pannello macchina === */
    .console-card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .console-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .console-title{grid-column:1/13;text-align:center;font-weight:800;font-size:18px;color:var(--text)}
    .console-box{border:2px solid var(--border);border-radius:12px;background:var(--table-head);padding:10px;display:flex;flex-direction:column;gap:6px;justify-content:center}
    .console-kv{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .console-label{color:var(--muted);font-size:14px}
    .console-value{font-weight:800;font-size:22px}
    .console-big{grid-column:7/13;border:3px solid var(--border);background:var(--card)}
    .console-big .console-value{font-size:42px;text-align:center}
    .console-num, .console-txt{width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);text-align:center;font-weight:800;font-size:20px}
    .console-actions{display:flex;gap:10px;justify-content:space-between;margin-top:14px}
    .console-actions button{flex:1}
    .console-mini{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .console-caption{font-size:12px;color:var(--muted)}
    .cont-list{margin:0;padding-left:18px;max-height:130px;overflow:auto}
    .cont-list li{margin:2px 0}
    @media(max-width:860px){.console-grid{grid-template-columns:1fr}.console-big{grid-column:1/2}}
    .hidden{display:none}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="app.js?v=15"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"><img src="assets/icon-512.png?v=15" alt="Logo SKF"></div>
        <div>
          <div style="font-weight:800;font-size:18px;letter-spacing:.3px">Kardex Viewer</div>
          <div class="muted" style="opacity:.9">Ricerca ‚Ä¢ Filtri ‚Ä¢ Importa/Esporta ‚Ä¢ Offline</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="tabData" class="toggle" title="Vista dati">üìã Dati</button>
        <button id="tabConsole" class="toggle" title="Vista console">üñ•Ô∏è Console</button>
        <button id="theme" class="toggle" title="Tema">üåô Tema</button>
        <button id="reset" class="toggle" title="Resetta">‚Ü∫ Reset impostazioni</button>
      </div>
    </div>
  </header>

  <main>
    <!-- ===== DATI ===== -->
    <section class="card" id="dataView">
      <div class="row">
        <input id="q" type="text" placeholder="Cerca veloce‚Ä¶" />
        <select id="campo" title="Campo">
          <option value="ALL">Campo: Tutti</option>
          <option value="RIPIANO">Ripiano</option>
          <option value="TIPO">Tipo</option>
          <option value="POSIZIONE">Posizione</option>
        </select>
        <button id="clear" class="secondary">Pulisci</button>
        <button id="export">Export CSV</button>
        <span class="count" id="count">0 risultati</span>
      </div>

      <details class="filters" open>
        <summary>Filtri avanzati (AND)</summary>
        <div class="grid">
          <div class="field"><label for="f_rip">Ripiano</label><input id="f_rip" type="text" placeholder="es. 10" /></div>
          <div class="field"><label for="f_tip">Tipo</label><input id="f_tip" type="text" placeholder="es. =Montaggio" /></div>
          <div class="field"><label for="f_pos">Posizione</label><input id="f_pos" type="text" placeholder="es. Sinistra" /></div>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:6px 0;color:var(--muted)">Preset filtri</h4>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <input id="presetName" type="text" placeholder="Nome preset" style="flex:1"/>
            <button id="savePreset">üíæ Salva</button>
          </div>
          <div id="presetList" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px"></div>
          <p class="hint" style="margin-top:6px">
            Sintassi: <b>=Montaggio</b> (esatto), <b>Mont*</b> (inizia con), <b>!Scarto</b> (escludi). Ripiano solo numeri ‚áí match esatto del numero iniziale.
          </p>
        </div>
      </details>

      <div class="row" style="margin-top:8px">
        <input id="file" type="file" accept=".xlsx,.csv" />
        <span class="muted">Carica un file per aggiornare la tabella (usa la prima sheet)</span>
      </div>

      <table>
        <thead>
          <tr>
            <th class="sortable" data-key="RIPIANO">RIPIANO <span class="sort"></span></th>
            <th class="sortable" data-key="TIPO">TIPO <span class="sort"></span></th>
            <th class="sortable" data-key="POSIZIONE">POSIZIONE <span class="sort"></span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <p class="hint">Click = ordina per colonna. <b>SHIFT + Click</b> aggiunge ordinamento secondario (‚ñ≤1, ‚ñº2, ‚Ä¶).</p>
    </section>

    <!-- ===== CONSOLE ===== -->
    <section id="consoleView" class="console-card hidden">
      <div class="console-grid">
        <div class="console-title">Mod. semi-automatica</div>

        <!-- Info + Contenuto -->
        <div class="console-box" style="grid-column:1/7">
          <div class="console-kv"><span class="console-label">Altezza</span><span class="console-value"><span id="c_alt_val">400</span> mm</span></div>
          <div class="console-kv"><span class="console-label">Peso per vassoio</span><span class="console-value"><span id="c_peso_val">650</span> kg</span></div>
          <div class="console-kv"><span class="console-label">Carico attuale</span><span class="console-value"><span id="c_carico_val">177</span> kg</span></div>
          <div class="console-kv"><span class="console-label">Vassoio attuale</span><span class="console-value" id="c_vassoio_att">-</span></div>
          <div class="console-kv"><span class="console-label">Contenuto</span><span class="console-label" id="c_cont_hint">(TIPO presenti)</span></div>
          <ul id="c_cont_list" class="cont-list"></ul>
        </div>

        <!-- Vassoio target -->
        <div class="console-box console-big">
          <div class="console-label">Vassoio</div>
          <input id="c_vassoio_target" type="number" class="console-num" value="0" min="0" />
          <div class="console-caption">Inserisci il numero vassoio da richiamare</div>
        </div>

        <!-- Posizioni (testuali) -->
        <div class="console-box" style="grid-column:1/7">
          <div class="console-label">Posizione A</div>
          <input id="c_pos_a" class="console-txt" type="text" value="-" readonly />
        </div>
        <div class="console-box" style="grid-column:7/13">
          <div class="console-label">Posizione B</div>
          <input id="c_pos_b" class="console-txt" type="text" value="-" readonly />
        </div>

        <!-- Azioni -->
        <div class="console-actions" style="grid-column:1/13">
          <button id="c_home" class="secondary">üè† Home</button>
          <button id="c_modifica" class="secondary">‚úèÔ∏è Modifica</button>
          <button id="c_svuota" class="secondary">üóëÔ∏è Svuota</button>
          <button id="c_sblocca" class="secondary">üîì Sblocca</button>
          <button id="c_preleva">‚¨áÔ∏è Preleva</button>
        </div>
      </div>
    </section>

    <p class="muted" style="margin-top:10px">Dopo il primo caricamento, il sito funziona anche offline (Aggiungi a schermata Home su Android).</p>
  </main>

  <footer>Versione UI: <strong>v15</strong></footer>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js?v=15'));
    }
  </script>
</body>
</html>
