<!DOCTYPE html>
<html lang="it" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kardex Viewer</title>
  <link rel="manifest" href="manifest.webmanifest?v=19" />
  <meta name="theme-color" content="#0e4ead" />
  <link rel="apple-touch-icon" href="assets/icon-512.png?v=19" />
  <link rel="icon" href="favicon.ico?v=19" type="image/x-icon">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280;
      --primary:#0e4ead; --primary-weak:#e5efff; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(2,6,23,.08); --pill-bg:#eef2ff; --pill-text:#3730a3;
      --table-head:#f3f4f6; --row-alt:#fafafa; --row-hover:#f1f5ff; --badge:#eaeef9;
    }
    @media (prefers-color-scheme: dark){
      html[data-theme="auto"]{
        --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --primary:#60a5fa;
        --primary-weak:#0b1b38; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35);
        --pill-bg:#0b1b38; --pill-text:#bfdbfe; --table-head:#0b1b38; --row-alt:#0b1426; --row-hover:#142549; --badge:#0b1b38;
      }
    }
    html[data-theme="dark"]{
      --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --primary:#60a5fa;
      --primary-weak:#0b1b38; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35);
      --pill-bg:#0b1b38; --pill-text:#bfdbfe; --table-head:#0b1b38; --row-alt:#0b1426; --row-hover:#142549; --badge:#0b1b38;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{background:linear-gradient(135deg,var(--primary),#2563eb);color:#fff;padding:16px 18px;position:sticky;top:0;z-index:20;box-shadow:0 4px 18px rgba(0,0,0,.12)}
    .wrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:42px;height:42px;border-radius:12px;overflow:hidden;background:#fff;border:2px solid #ffffff55;display:flex;align-items:center;justify-content:center}
    .brand img{width:100%;height:100%;object-fit:contain}
    .toolbar{display:flex;gap:8px}
    .toggle{background:#ffffff22;color:#fff;border:1px solid #ffffff44;padding:8px 10px;border-radius:12px;cursor:pointer}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;border:1px solid var(--border);border-radius:12px}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.secondary{background:var(--primary-weak);color:var(--text)}
    .muted{color:var(--muted);font-size:12px}
    .count{margin-left:auto;color:var(--muted);font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--pill-bg);color:var(--pill-text);border-radius:999px;padding:4px 10px;font-size:12px;font-weight:600;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{background:var(--table-head);padding:12px;text-align:left;border-bottom:1px solid var(--border)}
    th.sortable{cursor:pointer}
    th .sort{margin-left:6px;font-size:12px;opacity:.8}
    td{padding:12px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(even){background:var(--row-alt)}
    tbody tr:hover{background:var(--row-hover)}
    @media(max-width:640px){
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{border:1px solid var(--border);border-radius:12px;padding:8px;margin-bottom:12px;background:var(--card)}
      td{display:grid;grid-template-columns:120px 1fr;gap:8px;border:none}
      td::before{content:attr(data-label);font-weight:600;color:var(--muted)}
    }
    details.filters{margin-top:10px}
    details.filters summary{cursor:pointer;padding:8px 10px;background:var(--table-head);border:1px solid var(--border);border-radius:12px}
    .filters .grid{margin-top:10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media(max-width:640px){.filters .grid{grid-template-columns:1fr}}

    /* Console */
    .console-card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .console-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .console-title{grid-column:1/13;text-align:center;font-weight:800}
    .box{border:2px solid var(--border);border-radius:12px;background:var(--table-head);padding:12px}
    .num{width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;background:#fff;text-align:center;font-weight:800;font-size:20px}
    .list{margin:8px 0 0;padding-left:0;list-style:none;max-height:260px;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:10px;background:var(--card);border:1px solid var(--border);margin-bottom:8px}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{background:var(--badge);border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    @media(max-width:860px){.console-grid{grid-template-columns:1fr}}
    .hidden{display:none}

    /* Side cards grandi */
    .sides{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
    @media(max-width:860px){.sides{grid-template-columns:1fr}}
    .side-card{background:var(--card);border:2px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;min-height:140px}
    .side-title{font-weight:800;margin-bottom:8px}
    .side-list{list-style:none;margin:0;padding:0}
    .side-list li{padding:6px 8px;border:1px solid var(--border);border-radius:10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="app.js?v=19"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"><img src="assets/icon-512.png?v=19" alt="SKF"></div>
        <div>
          <div style="font-weight:800">Kardex Viewer</div>
          <div class="muted">Ricerca ‚Ä¢ Filtri ‚Ä¢ Import/Export ‚Ä¢ Offline</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="tabData" class="toggle">üìã Dati</button>
        <button id="tabConsole" class="toggle">üñ•Ô∏è Console</button>
        <button id="theme" class="toggle">üåô Tema</button>
        <button id="reset" class="toggle">‚Ü∫ Reset impostazioni</button>
      </div>
    </div>
  </header>

  <main>
    <!-- ====== DATI ====== -->
    <section class="card" id="dataView">
      <div class="row">
        <input id="q" type="text" placeholder="Cerca veloce‚Ä¶">
        <select id="campo">
          <option value="ALL">Campo: Tutti</option>
          <option value="RIPIANO">Ripiano</option>
          <option value="TIPO">Tipo</option>
          <option value="POSIZIONE">Posizione</option>
        </select>
        <button id="clear" class="secondary">Pulisci</button>
        <button id="export">Export CSV</button>
        <button id="exportPresets" class="secondary">Export Preset</button>
        <input id="importPresets" type="file" accept="application/json" style="display:none">
        <button id="importPresetsBtn" class="secondary">Import Preset</button>
        <span id="count" class="count">0 risultati</span>
      </div>

      <details class="filters" open>
        <summary>Filtri avanzati (AND)</summary>
        <div class="grid">
          <div><label class="muted">Ripiano</label><input id="f_rip" placeholder="es. 10"></div>
          <div><label class="muted">Tipo</label><input id="f_tip" placeholder="=Montaggio, Mont*, !Scarto"></div>
          <div><label class="muted">Posizione</label><input id="f_pos" placeholder="es. Sinistra"></div>
        </div>
        <div style="margin-top:10px">
          <div class="row" style="gap:6px">
            <input id="presetName" placeholder="Nome preset" style="flex:1">
            <button id="savePreset">üíæ Salva</button>
          </div>
          <div id="presetList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"></div>
          <p class="muted" style="margin-top:6px">SHIFT + click sull‚Äôintestazione per ordinamento multiplo (‚ñ≤1, ‚ñº2‚Ä¶)</p>
        </div>
      </details>

      <div class="row" style="margin-top:8px">
        <input id="file" type="file" accept=".xlsx,.csv">
        <span class="muted">Carica un file per aggiornare la tabella (prima sheet)</span>
      </div>

      <table>
        <thead><tr>
          <th class="sortable" data-key="RIPIANO">RIPIANO <span class="sort"></span></th>
          <th class="sortable" data-key="TIPO">TIPO <span class="sort"></span></th>
          <th class="sortable" data-key="POSIZIONE">POSIZIONE <span class="sort"></span></th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- ====== CONSOLE ====== -->
    <section id="consoleView" class="console-card hidden">
      <div class="console-grid">
        <div class="console-title">Console inventario</div>

        <!-- Preset per Console -->
        <div class="box" style="grid-column:1/13;background:var(--card)">
          <div class="row" style="justify-content:space-between">
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
              <span class="muted">Preset Console:</span>
              <select id="c_preset_select"></select>
              <button id="c_preset_apply" class="secondary">Applica</button>
              <button id="c_preset_clear" class="secondary">‚úñ Pulisci preset</button>
            </div>
            <div class="muted" id="c_preset_desc">Nessun preset attivo</div>
          </div>
        </div>

        <!-- Vassoio target -->
        <div class="box" style="grid-column:1/13;background:var(--card)">
          <div class="row">
            <label class="muted" for="c_vassoio_target">Vassoio</label>
            <input id="c_vassoio_target" type="number" class="num" min="0" value="0" style="max-width:220px">
            <button id="c_preleva">‚¨áÔ∏è Preleva</button>
            <button id="c_svuota" class="secondary">üóëÔ∏è Svuota</button>
            <button id="c_home" class="secondary">üè† Home</button>
          </div>
        </div>

        <!-- Contenuto -->
        <div class="box" style="grid-column:1/13;background:var(--card)">
          <div class="row" style="justify-content:space-between">
            <strong id="c_title">Contenuto vassoio ‚Äî</strong>
            <span class="muted" id="c_rows_hint">0 righe</span>
          </div>
          <ul id="c_cont_list" class="list"></ul>
        </div>

        <!-- Posizioni: carte grandi con elenco tipi -->
        <div class="sides" style="grid-column:1/13">
          <div class="side-card">
            <div class="side-title">Sinistra: <b id="pos_sx">‚Äî</b></div>
            <ul id="pos_sx_list" class="side-list"></ul>
          </div>
          <div class="side-card">
            <div class="side-title">Centrale: <b id="pos_ct">‚Äî</b></div>
            <ul id="pos_ct_list" class="side-list"></ul>
          </div>
          <div class="side-card">
            <div class="side-title">Destra: <b id="pos_dx">‚Äî</b></div>
            <ul id="pos_dx_list" class="side-list"></ul>
          </div>
        </div>

      </div>
    </section>

    <p class="muted" style="margin-top:10px">Dopo il primo caricamento, il sito funziona anche offline (Aggiungi a schermata Home).</p>
  </main>

  <footer style="text-align:center;margin:16px 0" class="muted">Versione UI: <b>v19</b></footer>

  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js?v=19'));
    }
  </script>
</body>
</html>
